<div class="row">
  <div class="col-lg-8">
    <!-- Discussion Content -->
    <div class="card shadow-sm mb-4">
      <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h1 class="h4 mb-2"><%= @discussion.title %></h1>
            <div class="d-flex align-items-center text-muted small">
              <span class="badge me-2" style="background-color: <%= @channel.color %>;">
                <%= @channel.name %>
              </span>
              by <%= @discussion.user.display_name %>
              <span class="mx-2">â€¢</span>
              <%= time_ago_in_words_or_date(@discussion.created_at) %>
              <% if @discussion.pinned? %>
                <i class="fas fa-thumbtack text-warning ms-2" title="Pinned"></i>
              <% end %>
            </div>
          </div>
          <% if can? :edit, @discussion %>
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-v"></i>
              </button>
              <ul class="dropdown-menu">
                <li><%= link_to "Edit", edit_channel_discussion_path(@channel, @discussion), class: "dropdown-item" %></li>
                <li><%= link_to "Delete", channel_discussion_path(@channel, @discussion), method: :delete, 
                        confirm: "Are you sure?", class: "dropdown-item text-danger" %></li>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
      <div class="card-body">
        <div class="d-flex mb-3">
          <div class="flex-shrink-0 me-3">
            <%= user_avatar(@discussion.user, size: 'lg') %>
          </div>
          <div class="flex-grow-1">
            <div class="discussion-content">
              <%= markdown(@discussion.content) %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Replies Section -->
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <h5 class="mb-0">
          <i class="fas fa-reply me-2"></i>
          Replies (<span id="replies-count"><%= @discussion.replies_count %></span>)
        </h5>
      </div>
      <div class="card-body p-0">
        <div id="replies-container">
          <%= render @replies %>
        </div>
        
        <% if @replies.respond_to?(:total_pages) && @replies.total_pages > 1 %>
          <div class="p-3 border-top text-center">
            <%= paginate @replies %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Reply Form -->
    <% if user_signed_in? %>
      <div class="card shadow-sm mt-4">
        <div class="card-header bg-white">
          <h6 class="mb-0">Post a Reply</h6>
        </div>
        <div class="card-body">
          <%= form_with model: [@channel, @discussion, @reply], local: false, id: "reply-form" do |form| %>
            <div class="mb-3">
              <%= form.text_area :content, class: "form-control", rows: 6, 
                  placeholder: "Write your reply here... (Markdown supported)" %>
              <div class="form-text">
                <i class="fab fa-markdown me-1"></i>
                Markdown is supported. You can use **bold**, *italic*, `code`, and more.
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                <i class="fas fa-user me-1"></i>
                Posting as <%= current_user.display_name %>
              </small>
              <%= form.submit "Post Reply", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="card shadow-sm mt-4">
        <div class="card-body text-center">
          <p class="mb-3">Please sign in to post a reply.</p>
          <%= link_to "Sign In", new_user_session_path, class: "btn btn-primary me-2" %>
          <%= link_to "Sign Up", new_user_registration_path, class: "btn btn-outline-primary" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Sidebar -->
  <div class="col-lg-4">
    <div class="card shadow-sm">
      <div class="card-header bg-dark text-white">
        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Discussion Info</h6>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <strong>Channel:</strong>
          <%= link_to @channel.name, channel_path(@channel), 
              class: "text-decoration-none ms-2" %>
        </div>
        <div class="mb-3">
          <strong>Author:</strong>
          <span class="ms-2"><%= @discussion.user.display_name %></span>
        </div>
        <div class="mb-3">
          <strong>Created:</strong>
          <span class="ms-2"><%= @discussion.created_at.strftime("%B %d, %Y at %I:%M %p") %></span>
        </div>
        <div class="mb-0">
          <strong>Replies:</strong>
          <span class="ms-2"><%= @discussion.replies_count %></span>
        </div>
      </div>
    </div>
  </div>
</div>